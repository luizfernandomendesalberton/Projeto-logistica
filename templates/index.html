<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Logística de Estoque</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script>
        // Verificar autenticação ao carregar a página
        document.addEventListener('DOMContentLoaded', async function() {
            try {
                const response = await fetch('/api/auth/check-session');
                if (!response.ok) {
                    window.location.href = '/login';
                    return;
                }
                const data = await response.json();
                if (!data.authenticated) {
                    window.location.href = '/login';
                    return;
                }
                // Usuário autenticado, continuar carregamento
                window.currentUser = data.user;
                initializePage();
            } catch (error) {
                console.error('Erro ao verificar autenticação:', error);
                window.location.href = '/login';
            }
        });

        function initializePage() {
            // Adicionar informações do usuário
            addUserInfo();
            // Continuar com o carregamento normal da página
            if (typeof loadDashboardData === 'function') {
                loadDashboardData();
            }
        }

        function addUserInfo() {
            if (window.currentUser) {
                // Adicionar botão de logout e info do usuário na navbar
                const navMenu = document.querySelector('.nav-menu');
                const userSection = document.createElement('div');
                userSection.className = 'nav-user';
                userSection.innerHTML = `
                    <div class="user-info">
                        <span class="user-name">${window.currentUser.username}</span>
                        ${window.currentUser.is_admin ? '<span class="admin-badge">Admin</span>' : ''}
                    </div>
                    <button class="logout-btn" onclick="logout()">
                        <i class="fas fa-sign-out-alt"></i>
                    </button>
                `;
                navMenu.appendChild(userSection);
            }
        }

        async function logout() {
            if (confirm('Deseja realmente sair do sistema?')) {
                try {
                    await fetch('/api/auth/logout', { method: 'POST' });
                } catch (error) {
                    console.error('Erro no logout:', error);
                } finally {
                    window.location.href = '/login';
                }
            }
        }
    </script>
</head>
<body>
    <nav class="navbar">
        <div class="nav-container">
            <div class="nav-logo">
                <i class="fas fa-warehouse"></i>
                <h1>LogiStock</h1>
            </div>
            <div class="nav-menu">
                <a href="/" class="nav-link active">
                    <i class="fas fa-home"></i>
                    Dashboard
                </a>
                <a href="/produtos" class="nav-link">
                    <i class="fas fa-box"></i>
                    Produtos
                </a>
                <a href="/estoque" class="nav-link">
                    <i class="fas fa-cubes"></i>
                    Estoque
                </a>
                <a href="/relatorios" class="nav-link">
                    <i class="fas fa-chart-bar"></i>
                    Relatórios
                </a>
            </div>
        </div>
    </nav>

    <main class="main-content">
        <div class="container">
            <!-- Dashboard Cards -->
            <div class="dashboard-cards">
                <div class="card">
                    <div class="card-icon products">
                        <i class="fas fa-box"></i>
                    </div>
                    <div class="card-info">
                        <h3 id="total-produtos">0</h3>
                        <p>Total de Produtos</p>
                    </div>
                </div>

                <div class="card">
                    <div class="card-icon stock">
                        <i class="fas fa-cubes"></i>
                    </div>
                    <div class="card-info">
                        <h3 id="itens-estoque">0</h3>
                        <p>Itens em Estoque</p>
                    </div>
                </div>

                <div class="card">
                    <div class="card-icon low-stock">
                        <i class="fas fa-exclamation-triangle"></i>
                    </div>
                    <div class="card-info">
                        <h3 id="estoque-baixo">0</h3>
                        <p>Estoque Baixo</p>
                    </div>
                </div>

                <div class="card">
                    <div class="card-icon movements">
                        <i class="fas fa-exchange-alt"></i>
                    </div>
                    <div class="card-info">
                        <h3 id="movimentacoes-hoje">0</h3>
                        <p>Movimentações Hoje</p>
                    </div>
                </div>
            </div>

            <!-- Alerts Section -->
            <div class="alerts-section">
                <h2><i class="fas fa-bell"></i> Alertas</h2>
                <div id="alerts-container" class="alerts-container">
                    <!-- Os alertas serão carregados via JavaScript -->
                </div>
            </div>

            <!-- Recent Activities -->
            <div class="recent-activities">
                <h2><i class="fas fa-history"></i> Atividades Recentes</h2>
                <div class="activities-table-container">
                    <table class="activities-table">
                        <thead>
                            <tr>
                                <th>Data/Hora</th>
                                <th>Produto</th>
                                <th>Tipo</th>
                                <th>Quantidade</th>
                                <th>Descrição</th>
                            </tr>
                        </thead>
                        <tbody id="recent-activities-body">
                            <!-- As atividades serão carregadas via JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </main>

    <!-- Loading Overlay -->
    <div id="loading" class="loading-overlay">
        <div class="loading-spinner"></div>
    </div>

    <!-- Scripts -->
    <script src="{{ url_for('static', filename='js/main.js') }}"></script>
    <script src="{{ url_for('static', filename='js/dashboard.js') }}"></script>
</body>
</html>